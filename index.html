<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Pong: Enhanced Instructions and Ball Acceleration</title>
  <style>
    body {
      background: linear-gradient(120deg, #ff8a80, #8c9eff);
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    #gameCanvas {
      background: #333;
      border: 4px solid #fff;
      display: block;
      margin: 40px auto;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
    }
    #score {
      position: absolute;
      top: 10px;
      width: 100%;
      text-align: center;
      color: #fff;
      font-size: 24px;
      z-index: 2;
    }
    #countdownMsg {
      position: absolute;
      top: 50px;
      width: 100%;
      text-align: center;
      color: #fff;
      font-size: 24px;
      z-index: 2;
    }
    #instructionsOverlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      display: flex; 
      align-items: center;
      justify-content: center;
      z-index: 3; 
    }
    #instructionsOverlay.hidden {
      display: none;
    }
    #instructionsContent {
      background: #222;
      padding: 30px;
      border-radius: 10px;
      width: 60%;
      max-width: 500px;
      text-align: center;
      color: #fff;
    }
    #winnerMsg {
      position: absolute;
      top: 40%;
      width: 100%;
      text-align: center;
      color: #ffea00;
      font-size: 36px;
      font-weight: bold;
      text-shadow: 2px 2px 5px #000;
      z-index: 4;
      display: none;
      font-family: Arial, sans-serif;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="800" height="400"></canvas>
  <div id="score">0 : 0</div>
  <div id="countdownMsg"></div>
  
  <!-- Instructions Overlay -->
  <div id="instructionsOverlay">
    <div id="instructionsContent">
      <h1>Welcome to Pong!</h1>
      <p><strong>Left Paddle:</strong> W (Up) / S (Down)</p>
      <p><strong>Right Paddle:</strong> O (Up) / L (Down)</p>
      <p><strong>P:</strong> Pause/Unpause the Game</p>
      <p><strong>H:</strong> Show/Hide Instructions (Pauses the Game)</p>
      <p><strong>Enter or Space:</strong> Start/Resume Play</p>
      <p>Reach 20 points to win the game!</p>
    </div>
  </div>
  
  <!-- Winner Message -->
  <div id="winnerMsg"></div>
  
  <script>
    // ----------------------- SOUND SETUP -----------------------
    const paddleHitSound = new Audio("https://www.myinstants.com/media/sounds/smw_jump.wav");
    const scoreSound     = new Audio("https://www.myinstants.com/media/sounds/smb_mariodie.wav");
    
    // ----------------------- CANVAS SETUP -----------------------
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // ----------------------- GAME CONSTANTS -----------------------
    const PADDLE_WIDTH      = 10;
    const PADDLE_HEIGHT     = 70;
    const PADDLE_MOVE_SPEED = 5; // Pixels per frame for smooth movement
    const BALL_RADIUS       = 8;
    const BASE_SPEED_X      = 3;
    const BASE_SPEED_Y      = 2;
    const WINNING_SCORE     = 20;
    const FIREWORKS_COUNT   = 20; // Number of fireworks bursts
    
    // ----------------------- GAME STATE VARIABLES -----------------------
    let leftScore = 0;
    let rightScore = 0;
    let leftY, rightY;
    let paddleVelocityLeft = 0;
    let paddleVelocityRight = 0;
    
    let ballX, ballY;
    let ballSpeedX, ballSpeedY;
    let volleyCount = 0; // Counts successful paddle hits
    
    let gameStopped    = false; // Controls overall game state
    let gamePaused     = true;  // Controls pause state
    let instructionsVisible = true;  
    let hideBall       = true;  
    let countdown      = 0;
    let nextReceiver   = '';
    let countdownTimer = null;
    
    // Scattering effect variables
    let scattering   = false;
    let scatterTimer = 0;
    let particles    = [];
    
    // Fireworks variables
    let gameOver      = false;
    let fireworks     = [];
    let winnerMsgDiv  = document.getElementById('winnerMsg');
    
    // DOM References
    const instructionsOverlay = document.getElementById('instructionsOverlay');
    const instructionsContent = document.getElementById('instructionsContent');
    
    // ----------------------- INITIALIZATION -----------------------
    function resetPositions() {
      leftY  = canvas.height / 2 - PADDLE_HEIGHT / 2;
      rightY = canvas.height / 2 - PADDLE_HEIGHT / 2;
    }
    
    // Start a 4-second countdown for serve
    function startServe(scorer) {
      if (scorer === 'left') {
        nextReceiver = 'right';
      } else if (scorer === 'right') {
        nextReceiver = 'left';
      } else {
        nextReceiver = Math.random() < 0.5 ? 'left' : 'right';
      }
      hideBall   = true;
      gamePaused = true;
      countdown  = 4;
    
      if (countdownTimer) clearInterval(countdownTimer);
      countdownTimer = setInterval(() => {
        countdown--;
        if (countdown <= 0) {
          clearInterval(countdownTimer);
          countdown = 0;
          gamePaused = false;
          placeBall();
        }
      }, 1000);
    }
    
    // Place the ball in the center and set initial speed
    function placeBall() {
      ballX = canvas.width / 2;
      ballY = canvas.height / 2;
      volleyCount = 0;
    
      let dir = (nextReceiver === 'left') ? -1 : 1;
      ballSpeedX = BASE_SPEED_X * dir;
      ballSpeedY = Math.random() < 0.5 ? -BASE_SPEED_Y : BASE_SPEED_Y;
      
      hideBall = false;
    }
    
    // Scatter the ball into particles upon scoring
    function scatterBall(x, y) {
      scattering  = true;
      scatterTimer = 60; // Approximately 1 second at ~60fps
      hideBall    = true;
      particles    = [];
    
      for (let i = 0; i < 20; i++) {
        let angle = Math.random() * 2 * Math.PI;
        let speed = 2 + Math.random() * 3;
        particles.push({
          x: x,
          y: y,
          vx: Math.cos(angle) * speed,
          vy: Math.sin(angle) * speed,
          alpha: 1.0
        });
      }
    }
    
    // ----------------------- FIREWORKS FUNCTIONS -----------------------
    function startFireworks(winner) {
      // Display winner message
      winnerMsgDiv.textContent = `${winner} WINS! ðŸŽ‰`;
      winnerMsgDiv.style.display = 'block';
      fireworks = [];
    
      // Create multiple firework bursts
      for (let i = 0; i < FIREWORKS_COUNT; i++) {
        createFireworkBurst();
      }
    }
    
    function createFireworkBurst() {
      // Each burst has 30 sparks
      const sparks = [];
      const x = Math.random() * canvas.width;
      const y = Math.random() * (canvas.height * 0.7); // Upper 70% of canvas
      for (let i = 0; i < 30; i++) {
        let angle = Math.random() * 2 * Math.PI;
        let speed = 2 + Math.random() * 3;
        sparks.push({
          x: x,
          y: y,
          vx: Math.cos(angle) * speed,
          vy: Math.sin(angle) * speed,
          alpha: 1.0,
          color: randomColor()
        });
      }
      fireworks.push(sparks);
    }
    
    function updateFireworks() {
      for (let s = 0; s < fireworks.length; s++) {
        let sparks = fireworks[s];
        for (let p of sparks) {
          p.x += p.vx;
          p.y += p.vy;
          p.alpha -= 0.02;
        }
        // Remove invisible sparks
        fireworks[s] = sparks.filter(sp => sp.alpha > 0);
        // If burst has no sparks left, create a new one
        if (fireworks[s].length === 0) {
          fireworks[s] = [];
          createFireworkBurst();
        }
      }
    }
    
    function drawFireworks() {
      for (let sparks of fireworks) {
        for (let p of sparks) {
          ctx.globalAlpha = p.alpha;
          ctx.fillStyle = p.color;
          ctx.beginPath();
          ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
          ctx.fill();
        }
      }
      ctx.globalAlpha = 1.0;
    }
    
    function randomColor() {
      const r = Math.floor(Math.random() * 256);
      const g = Math.floor(Math.random() * 256);
      const b = Math.floor(Math.random() * 256);
      return `rgb(${r},${g},${b})`;
    }
    
    // ----------------------- MAIN GAME LOOP FUNCTIONS -----------------------
    function moveEverything() {
      if (gameStopped || gamePaused || scattering || gameOver) return;
    
      // Smooth paddle movement
      leftY += paddleVelocityLeft;
      rightY += paddleVelocityRight;
    
      // Keep paddles within canvas
      leftY = Math.max(0, Math.min(canvas.height - PADDLE_HEIGHT, leftY));
      rightY = Math.max(0, Math.min(canvas.height - PADDLE_HEIGHT, rightY));
    
      // Move ball
      ballX += ballSpeedX;
      ballY += ballSpeedY;
    
      // Bounce off top and bottom
      if (ballY < 0 && ballSpeedY < 0) ballSpeedY = -ballSpeedY;
      if (ballY > canvas.height && ballSpeedY > 0) ballSpeedY = -ballSpeedY;
    
      // Check collision with left paddle
      if (ballX < PADDLE_WIDTH + BALL_RADIUS) {
        if (ballY > leftY && ballY < leftY + PADDLE_HEIGHT) {
          ballSpeedX = Math.abs(ballSpeedX); // Ensure it's moving right
          volleyCount++;
          paddleHitSound.currentTime = 0;
          paddleHitSound.play();
    
          // Increment ball speed after 10 volleys
          if (volleyCount >= 10) {
            ballSpeedX *= 1.05; // 5% speed increase
            ballSpeedY *= 1.05;
          }
        } else {
          // Right player scores
          rightScore++;
          scoreSound.currentTime = 0;
          scoreSound.play();
          checkForWin('Right');
          if (!gameOver) scatterBall(ballX, ballY);
        }
      }
    
      // Check collision with right paddle
      if (ballX > canvas.width - PADDLE_WIDTH - BALL_RADIUS) {
        if (ballY > rightY && ballY < rightY + PADDLE_HEIGHT) {
          ballSpeedX = -Math.abs(ballSpeedX); // Ensure it's moving left
          volleyCount++;
          paddleHitSound.currentTime = 0;
          paddleHitSound.play();
    
          // Increment ball speed after 10 volleys
          if (volleyCount >= 10) {
            ballSpeedX *= 1.05; // 5% speed increase
            ballSpeedY *= 1.05;
          }
        } else {
          // Left player scores
          leftScore++;
          scoreSound.currentTime = 0;
          scoreSound.play();
          checkForWin('Left');
          if (!gameOver) scatterBall(ballX, ballY);
        }
      }
    }
    
    function checkForWin(scoringPlayer) {
      if (scoringPlayer === 'Left' && leftScore >= WINNING_SCORE) {
        endGame('LEFT');
      } else if (scoringPlayer === 'Right' && rightScore >= WINNING_SCORE) {
        endGame('RIGHT');
      }
    }
    
    function endGame(winner) {
      gameOver = true;
      hideBall = true;
      winnerMsgDiv.textContent = `${winner} WINS! ðŸŽ‰`;
      winnerMsgDiv.style.display = 'block';
      startFireworks(winner);
    }
    
    function drawEverything() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    
      // Draw paddles
      ctx.fillStyle = '#aa00ff'; // Left paddle color
      ctx.fillRect(0, leftY, PADDLE_WIDTH, PADDLE_HEIGHT);
      ctx.fillStyle = '#00e676'; // Right paddle color
      ctx.fillRect(canvas.width - PADDLE_WIDTH, rightY, PADDLE_WIDTH, PADDLE_HEIGHT);
    
      // Draw ball
      if (!hideBall && !scattering && !gameOver) {
        ctx.fillStyle = '#ffd600'; // Ball color
        ctx.beginPath();
        ctx.arc(ballX, ballY, BALL_RADIUS, 0, Math.PI * 2);
        ctx.fill();
      }
    
      // Draw scatter particles
      if (scattering) {
        drawParticles();
      }
    
      // Draw fireworks
      if (gameOver) {
        drawFireworks();
      }
    
      // Draw net
      ctx.setLineDash([5, 15]);
      ctx.strokeStyle = '#ffffff';
      ctx.beginPath();
      ctx.moveTo(canvas.width / 2, 0);
      ctx.lineTo(canvas.width / 2, canvas.height);
      ctx.stroke();
      ctx.setLineDash([]); // Reset line dash
    
      // Update score and countdown messages
      document.getElementById('score').textContent = `${leftScore} : ${rightScore}`;
      let msg = "";
      if (gameStopped) {
        msg = "Press ENTER or SPACE to begin";
      } else if (gamePaused && countdown > 0) {
        msg = `${nextReceiver.charAt(0).toUpperCase() + nextReceiver.slice(1)} receives in ${countdown}s`;
      }
      document.getElementById('countdownMsg').textContent = msg;
    }
    
    function gameLoop() {
      if (scattering) {
        updateParticles();
      }
      if (gameOver) {
        updateFireworks();
      }
      moveEverything();
      drawEverything();
      requestAnimationFrame(gameLoop);
    }
    
    // Start the game loop
    gameLoop();
    
    // ----------------------- START/STOP AND INSTRUCTIONS -----------------------
    function stopGame() {
      gameStopped = true;
      gamePaused  = true;
      hideBall    = true;
      if (countdownTimer) clearInterval(countdownTimer);
    }
    
    function startGame() {
      // Reset scores and states for a new game
      leftScore  = 0;
      rightScore = 0;
      gameOver   = false;
      winnerMsgDiv.style.display = 'none';
      fireworks  = [];
      
      gameStopped = false;
      resetPositions();
      startServe(null);
    }
    
    function toggleInstructions() {
      instructionsVisible = !instructionsVisible;
      if (instructionsVisible) {
        instructionsOverlay.classList.remove('hidden');
        gamePaused = true;
      } else {
        instructionsOverlay.classList.add('hidden');
        if (!gameStopped && !scattering && !gameOver) {
          gamePaused = false;
        }
      }
    }
    
    // Initially show instructions and pause the game
    stopGame();
    instructionsVisible = true;
    instructionsOverlay.classList.remove('hidden');
    
    // ----------------------- KEYBOARD INPUT HANDLING -----------------------
    window.addEventListener('keydown', (e) => {
      const key = e.key.toLowerCase();
      
      if (gameOver) {
        // Restart the game on any key press after game over
        startGame();
        return;
      }
      
      switch(key) {
        case 'w':
          paddleVelocityLeft = -PADDLE_MOVE_SPEED;
          break;
        case 's':
          paddleVelocityLeft = PADDLE_MOVE_SPEED;
          break;
        case 'o':
          paddleVelocityRight = -PADDLE_MOVE_SPEED;
          break;
        case 'l':
          paddleVelocityRight = PADDLE_MOVE_SPEED;
          break;
        case 'enter':
        case ' ':
          if (instructionsVisible) {
            toggleInstructions();
          }
          if (gameStopped) {
            startGame();
          } else if (gamePaused && !instructionsVisible && !scattering) {
            gamePaused = false;
          }
          break;
        case 'p':
          if (!instructionsVisible && !gameStopped && !scattering && !gameOver) {
            gamePaused = !gamePaused;
          }
          break;
        case 'h':
          toggleInstructions();
          break;
      }
    });
    
    window.addEventListener('keyup', (e) => {
      const key = e.key.toLowerCase();
      switch(key) {
        case 'w':
        case 's':
          paddleVelocityLeft = 0;
          break;
        case 'o':
        case 'l':
          paddleVelocityRight = 0;
          break;
      }
    });
  </script>
</body>
</html>
